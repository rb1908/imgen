generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Project {
  id              String       @id @default(uuid())
  name            String?      @default("Untitled Project")
  description     String?      // Product description
  tags            String?      // Comma separated tags
  price           String?      // Price string
  shopifyId       String?      // External ID if imported
  originalImageUrl String      // Store the base/original image URL
  defaultProductId String?     // Link to a Product (Shopify ID)
  userId          String       @default("user_default") // Owner ID
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  generations     Generation[]

  @@index([userId])
}

model Template {
  id          String   @id @default(uuid())
  name        String
  purpose     String   @default("prompt") // prompt, social
  
  // Prompt specific
  prompt      String?
  
  // Social specific
  config      Json?    // { format: 'story', overlays: [...] }
  
  description String?
  thumbnailUrl String?
  category    String   @default("custom")
  userId      String   @default("user_default")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  generations Generation[]

  @@index([userId])
}

model SocialPost {
  id          String   @id @default(uuid())
  content     Json     // { imageUrl, overlays: [], caption: "" }
  platform    String   // instagram_story, instagram_feed, etc.
  status      String   @default("draft") // draft, scheduled, published
  scheduledAt DateTime?
  
  productId   String?
  product     Product? @relation(fields: [productId], references: [id])
  
  userId      String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([scheduledAt])
}

model Generation {
  id            String   @id @default(uuid())
  imageUrl      String
  customizedImageUrl String? // If edited, this holds the final output
  canvasState   Json?    // The JSON state of the editor for re-editing
  promptUsed    String?  // Snapshot of the prompt used (from template or ad-hoc)
  
  projectId     String
  project       Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  templateId    String?
  template      Template? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  
  createdAt     DateTime @default(now())

  @@index([projectId])
  @@index([templateId])
  @@index([createdAt])
}

model EtsyIntegration {
  id            String   @id @default(uuid())
  accessToken   String
  refreshToken  String
  tokenType     String   @default("Bearer")
  expiresIn     Int
  expiresAt     DateTime
  etsyUserId    String   // Numeric ID from Etsy
  shopId        String?  // Optional, if valid shop
  
  pkceVerifier  String?  // Temporary storage during auth if needed, but cookie is better.
  
  userId        String?  // Linked Clerk User
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userId])
}

model ShopifyIntegration {
  id            String   @id @default(uuid())
  shopDomain    String   @unique // myshop.myshopify.com
  accessToken   String
  scopes        String
  
  userId        String?  // Linked Clerk User
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userId])
}

model Product {
  id              String   @id // Shopify ID (using String to be safe)
  title           String
  description     String?
  price           String?
  images          String[] // Array of image URLs
  tags            String?
  productType     String? // Mapped to product_type in Shopify
  categoryId      String? // Shopify Standard Product Taxonomy Node ID (e.g. "aa-1")
  vendor          String? // Mapped to vendor in Shopify
  status          String   @default("active") // active, draft, archived
  
  updatedAt       DateTime @updatedAt // Last sync time
  syncedAt        DateTime @default(now())
  userId          String   @default("user_default")
  
  options         ProductOption[]
  variants        ProductVariant[]
  metafields      ProductMetafield[]
  posts           SocialPost[]
}

model ProductOption {
  id            String   @id @default(uuid())
  productId     String
  product       Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  name          String   // e.g. "Size", "Color"
  values        String   // JSON string or comma-separated for simplicity. Let's use Comma Separated for SQLite/Postgres compatibility without JSONB reliance if possible, but arrays are better. 
                         // Actually, Prisma supports String[] on Postgres but not SQLite. 
                         // To be safe for all, we will use a String and split it, OR a relation.
                         // But for simplicity in this stack, let's use a String with separator (e.g. comma).
  
  position      Int      @default(0)
}

model ProductVariant {
  id            String   @id // Shopify ID (numeric string) or UUID if local
  productId     String
  product       Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  title         String   // e.g. "Small / Red"
  price         String?
  sku           String?
  inventoryQty  Int      @default(0)
  
  // Option mapping (Shopify uses option1, option2, option3)
  option1       String?
  option2       String?
  option3       String?
  
  imageId       String?  // basic mapping
}

model ProductMetafield {
  id            String   @id @default(uuid())
  productId     String
  product       Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  namespace     String   @default("custom")
  key           String
  value         String
  type          String   @default("single_line_text_field")
}

model ProductTemplate {
  id          String   @id @default(uuid())
  name        String
  icon        String?  // Lucide icon name or emoji
  
  // Snapshot of product data
  data        Json     // { title, description, price, tags, productType, categoryId, attributes }
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  userId      String   @default("user_default")

  @@index([userId])
}
